---
name: Ansible Collection Workflow
on:
  workflow_call:
    inputs:
      fail-fast:
        default: true
        description: GitHubAction parameter for jobs strategy
        required: false
        type: boolean
      pre-test-cmd:
        default:
        description: Parameter for action paths-filter
        required: false
        type: string
      runs-on:
        default: 'ubuntu-latest'
        description: docker image to run GHA
        type: string
        required: false
      test-deps:
        default:
        description: Parameter for ansible-test-gh-action
        type: string
        required: false
      test-docker:
        default: true
        description: Test on all docker images
        type: boolean
        required: false
      test-python:
        default: true
        description: Test on all python versions (target)
        type: boolean
        required: false
      testing-type:
        default: integration
        description: Parameter for ansible-test-gh-action
        type: string
        required: true

jobs:
  changes:
    runs-on: ${{ inputs.runs-on }}
    outputs:
      targets: ${{ steps.filter.outputs.changes }}
    steps:
    - uses: actions/checkout@v2
      if: ${{ github.event_name != 'pull_request' }}
    # Run change detection to build tests
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: '.github/filters.yml'

  test-python:
    if: inputs.test-python
    name: "${{ matrix.target-python-version }} | ${{ matrix.ansible-core-version }} | ${{ matrix.python-version }}"
    needs: changes
    runs-on: ${{ inputs.runs-on }}
    steps:
    - name: "ansible-test ${{ inputs.testing-type }} ${{ join(fromJSON(needs.changes.outputs.targets), ' ') }}"
      uses: ansible-community/ansible-test-gh-action@stable/v1.3
      with:
        ansible-core-version: ${{ matrix.ansible-core-version }}
        pre-test-cmd: ${{ inputs.pre-test-cmd }}
        python-version: ${{ matrix.python-version }}
        target: ${{ join(fromJSON(needs.changes.outputs.targets), ' ') }}
        target-python-version: ${{ matrix.target-python-version }}
        testing-type: ${{ inputs.testing-type }}
        test-deps: ${{ inputs.test-deps }}
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        # https://docs.ansible.com/ansible/devel/reference_appendices/release_and_maintenance.html#ansible-core-changelogs
        ansible-core-version:
        - stable-2.9       # EOL May 2022
        - stable-2.10      # EOL May 2022
        - stable-2.11      # EOL May 2022
        - stable-2.12      # EOL May 2023
        - devel
        python-version:
        - 3.8
        target-python-version:
        - 3.9
        - 3.8
        - 3.7
        - 3.6
        - 3.5
        - 2.7
        - 2.6
        exclude:
        - ansible-core-version: stable-2.9
          target-python-version: 3.9
        - ansible-core-version: stable-2.9
          target-python-version: 3.10
        - ansible-core-version: stable-2.10
          target-python-version: 3.10
        - ansible-core-version: stable-2.11
          target-python-version: 3.10
        - ansible-core-version: devel
          target-python-version: 2.6

  test-docker:
    if: inputs.test-docker
    name: "${{ matrix.docker-image }} | ${{ matrix.ansible-core-version }} | ${{ matrix.python-version }}"
    needs: changes
    runs-on: ${{ inputs.runs-on }}
    steps:
    - name: "ansible-test ${{ inputs.testing-type }} ${{ join(fromJSON(needs.changes.outputs.targets), ' ') }}"
      uses: ansible-community/ansible-test-gh-action@stable/v1.3
      with:
        ansible-core-version: ${{ matrix.ansible-core-version }}
        docker-image: ${{ matrix.docker-image }}
        pre-test-cmd: ${{ inputs.pre-test-cmd }}
        python-version: ${{ matrix.python-version }}
        target: ${{ join(fromJSON(needs.changes.outputs.targets), ' ') }}
        testing-type: ${{ inputs.testing-type }}
        test-deps: ${{ inputs.test-deps }}
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        # https://docs.ansible.com/ansible/devel/reference_appendices/release_and_maintenance.html#ansible-core-changelogs
        ansible-core-version:
        - stable-2.9       # EOL May 2022
        - stable-2.10      # EOL May 2022
        - stable-2.11      # EOL May 2022
        - stable-2.12      # EOL May 2023
        - devel
        python-version:
        - 3.8
        # devel: https://github.com/ansible/ansible/blob/devel/test/lib/ansible_test/_data/completion/docker.txt
        docker-image:
        - alpine3                        # python 3.9
        - centos6                        # python 2.6
        - centos7                        # python 2.7
        - centos8                        # python 3.6
        - fedora34                       # python 3.9
        - opensuse15py2                  # python 2.7
        - opensuse15                     # python 3.6
        - ubuntu1804                     # python 3.6
        - ubuntu2004                     # python 3.8

        include:
        - ansible-core-version: stable-2.9
          docker-image: fedora30         # python 3.7
          python-version: 3.8
        - ansible-core-version: stable-2.9
          docker-image: fedora31         # python 3.7
          python-version: 3.8
        - ansible-core-version: stable-2.9
          docker-image: ubuntu1604       # python 2.7
          python-version: 3.8
        - ansible-core-version: stable-2.10
          docker-image: fedora30         # python 3.7
          python-version: 3.8
        - ansible-core-version: stable-2.10
          docker-image: fedora31         # python 3.7
          python-version: 3.8
        - ansible-core-version: stable-2.10
          docker-image: fedora32         # python 3.8
          python-version: 3.8
        - ansible-core-version: stable-2.10
          docker-image: ubuntu1604       # python 2.7
          python-version: 3.8
        - ansible-core-version: stable-2.11
          docker-image: fedora32         # python 3.8
          python-version: 3.8
        - ansible-core-version: stable-2.11
          docker-image: fedora33         # python 3.9
          python-version: 3.8
        - ansible-core-version: stable-2.12
          docker-image: centos6          # python 2.6
          python-version: 3.8
        - ansible-core-version: stable-2.12
          docker-image: fedora33         # python 3.9
          python-version: 3.8
        - ansible-core-version: devel
          docker-image: fedora35         # python 3.10
          python-version: 3.8

        exclude:
        - ansible-core-version: stable-2.9
          docker-image: alpine3
        - ansible-core-version: stable-2.9
          docker-image: fedora34
        - ansible-core-version: stable-2.9
          docker-image: ubuntu2004
        - ansible-core-version: stable-2.10
          docker-image: alpine3
        - ansible-core-version: stable-2.10
          docker-image: fedora34
        - ansible-core-version: stable-2.11
          docker-image: fedora34
        - ansible-core-version: devel
          docker-image: centos6
        - ansible-core-version: devel
          docker-image: centos8
